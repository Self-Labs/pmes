<!DOCTYPE html>
<!--
  Sistema de Escalas - Admin
  Vers√£o: 2.6
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Sistema de Escalas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="auth-loading">

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-content" style="max-width: 1000px;">
      <div class="navbar-brand">
        ‚öôÔ∏è Administra√ß√£o
        <span class="navbar-version">v2.6</span>
      </div>
      <div class="navbar-menu">
        <a href="/perfil" id="navbarUser" class="navbar-user" style="text-decoration: none; color: inherit; margin-right: 8px;" title="Ir para Perfil"></a>
        <a href="/diaria" class="btn btn-secondary">üìÜ Di√°ria</a>
        <a href="/mensal" class="btn btn-secondary">üìÖ Mensal</a>
        <a href="/iseo" class="btn btn-secondary">üöì ISEO</a>
        <a href="/admin" class="btn btn-active">‚öôÔ∏è Admin</a>
        <button onclick="logout()" class="btn btn-secondary">üö™ Sair</button>
      </div>
    </div>
  </nav>

  <div style="max-width: 1000px; margin: 24px auto; padding: 0 16px;">

    <!-- Tabs -->
    <div style="display: flex; border-bottom: 1px solid #ddd; margin-bottom: 24px;">
      <button class="tab-btn active" data-tab="pendentes">üïê Pendentes</button>
      <button class="tab-btn" data-tab="usuarios">üëÆ‚Äç‚ôÇÔ∏è Usu√°rios</button>
      <button class="tab-btn" data-tab="unidades">üèõÔ∏è Unidades</button>
    </div>

    <!-- Tab: Pendentes -->
    <div id="tab-pendentes" class="tab-content active card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">üïê Usu√°rios Aguardando Aprova√ß√£o</h2>
      <div id="listaPendentes"></div>
      <p id="semPendentes" class="hidden" style="color: #666; text-align: center; padding: 24px;">Nenhum usu√°rio pendente.</p>
    </div>

    <!-- Tab: Usu√°rios -->
    <div id="tab-usuarios" class="tab-content card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="font-size: 18px;">üëÆ‚Äç‚ôÇÔ∏è Todos os Usu√°rios</h2>
        <button onclick="abrirCriarUsuario()" class="btn btn-primary">‚ûï Novo Usu√°rio</button>
      </div>
      <div style="border: 1px solid #ddd; border-radius: 8px; overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Email</th>
              <th>Unidade</th>
              <th>Role</th>
              <th>Status</th>
              <th style="width: 150px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="listaUsuarios"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Unidades -->
    <div id="tab-unidades" class="tab-content card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">üèõÔ∏è Gerenciar Unidades</h2>

      <!-- Form Nova Unidade -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 2; min-width: 200px;">
          <label style="font-size: 12px; color: #666;">Sigla</label>
          <input type="text" id="novaSigla" class="form-input" placeholder="Ex: 9¬∫ BPM">
        </div>
        <div style="flex: 1; min-width: 120px;">
          <label style="font-size: 12px; color: #666;">Tipo</label>
          <select id="novoTipo" class="form-select">
            <option value="">Selecione</option>
            <option value="CPOR">CPOR</option>
            <option value="CPOE">CPOE</option>
            <option value="BPM">BPM</option>
            <option value="CIA_IND">CIA IND</option>
            <option value="CIA">CIA</option>
            <option value="COPOM">COPOM</option>
            <option value="PELOTAO">PELOT√ÉO</option>
            <option value="OUTRO">OUTRO</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label style="font-size: 12px; color: #666;">Unidade Pai</label>
          <select id="novoParent" class="form-select">
            <option value="">Nenhuma (raiz)</option>
          </select>
        </div>
        <button onclick="criarNovaUnidade()" class="btn btn-primary">‚ûï Adicionar</button>
      </div>

      <!-- Lista Unidades -->
      <div style="border: 1px solid #ddd; border-radius: 8px; overflow-x: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Estrutura Hier√°rquica</th>
              <th style="width: 120px;">Tipo</th>
              <th style="width: 100px; text-align: right;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="listaUnidades"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal Editar Usu√°rio -->
  <div id="modalEditarUsuario" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100;">
    <div class="card" style="width: 100%; max-width: 500px; margin: 20px;">
      <h2 style="font-size: 18px; margin-bottom: 16px;">‚úèÔ∏è Editar Usu√°rio</h2>
      
      <input type="hidden" id="editUserId">
      
      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Nome</label>
        <input type="text" id="editUserNome" class="form-input">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Email</label>
        <input type="email" id="editUserEmail" class="form-input">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Role</label>
        <select id="editUserRole" class="form-select">
          <option value="editor">Editor</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Comando Regional</label>
        <select id="editUserComando" class="form-select" onchange="carregarUnidadesPrincipaisEdit()">
          <option value="">Selecione...</option>
        </select>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Unidade (BPM/CIA IND)</label>
        <select id="editUserUnidade" class="form-select" onchange="carregarSubunidadesEdit()">
          <option value="">Selecione o comando regional primeiro</option>
        </select>
        <p style="font-size: 11px; color: #666; margin-top: 2px;">* Deixe vazio se pertencer √† sede do Comando.</p>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Subunidade (Cia/Pelot√£o) - Opcional</label>
        <select id="editUserSubunidade" class="form-select" disabled>
          <option value="">Selecione a unidade primeiro</option>
        </select>
        <p style="font-size: 11px; color: #666; margin-top: 2px;">* Deixe vazio se pertencer √† sede da Unidade.</p>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Status</label>
        <select id="editUserAtivo" class="form-select">
          <option value="true">Ativo</option>
          <option value="false">Pendente</option>
        </select>
      </div>

      <div style="display: flex; gap: 12px;">
        <button onclick="fecharModalUsuario()" class="btn btn-secondary" style="flex: 1;">Cancelar</button>
        <button onclick="salvarUsuario()" class="btn btn-primary" style="flex: 1;">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Unidade -->
  <div id="modalEditarUnidade" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100;">
    <div class="card" style="width: 100%; max-width: 400px; margin: 20px;">
      <h2 style="font-size: 18px; margin-bottom: 16px;">‚úèÔ∏è Editar Unidade</h2>
      
      <input type="hidden" id="editUnidadeId">
      
      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Sigla</label>
        <input type="text" id="editUnidadeSigla" class="form-input">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Tipo</label>
        <select id="editUnidadeTipo" class="form-select">
          <option value="CPOR">CPOR</option>
          <option value="CPOE">CPOE</option>
          <option value="BPM">BPM</option>
          <option value="CIA_IND">CIA IND</option>
          <option value="CIA">CIA</option>
          <option value="COPOM">COPOM</option>
          <option value="PELOTAO">PELOT√ÉO</option>
          <option value="OUTRO">OUTRO</option>
        </select>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Unidade Pai</label>
        <select id="editUnidadeParent" class="form-select">
          <option value="">Nenhuma (raiz)</option>
        </select>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Status</label>
        <select id="editUnidadeAtivo" class="form-select">
          <option value="true">Ativo</option>
          <option value="false">Inativo</option>
        </select>
      </div>

      <div style="display: flex; gap: 12px;">
        <button onclick="fecharModalUnidade()" class="btn btn-secondary" style="flex: 1;">Cancelar</button>
        <button onclick="salvarUnidade()" class="btn btn-primary" style="flex: 1;">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <div id="modalCriarUsuario" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100;">
    <div class="card" style="width: 100%; max-width: 500px; margin: 20px;">
      <h2 style="font-size: 18px; margin-bottom: 16px;">‚ûï Novo Usu√°rio</h2>
      
      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Nome</label>
        <input type="text" id="newUserNome" class="form-input" placeholder="Nome completo">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Email</label>
        <input type="email" id="newUserEmail" class="form-input" placeholder="email@exemplo.com">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Senha</label>
        <input type="password" id="newUserSenha" class="form-input" placeholder="M√≠nimo 6 caracteres">
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Role</label>
        <select id="newUserRole" class="form-select">
          <option value="editor">Editor</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Comando Regional</label>
        <select id="newUserComando" class="form-select" onchange="carregarUnidadesPrincipaisNew()">
          <option value="">Selecione...</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Unidade (BPM/CIA IND)</label>
        <select id="newUserUnidade" class="form-select" onchange="carregarSubunidadesNew()">
          <option value="">Selecione o comando regional primeiro</option>
        </select>
        <p style="font-size: 11px; color: #666; margin-top: 2px;">* Deixe vazio se pertencer √† sede do Comando.</p>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Subunidade (Cia/Pelot√£o) - Opcional</label>
        <select id="newUserSubunidade" class="form-select" disabled>
          <option value="">Selecione a unidade primeiro</option>
        </select>
        <p style="font-size: 11px; color: #666; margin-top: 2px;">* Deixe vazio se pertencer √† sede da Unidade.</p>
      </div>

      <div class="mb-4">
        <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">Status Inicial</label>
        <select id="newUserAtivo" class="form-select">
          <option value="true">Ativo (Aprovado)</option>
          <option value="false">Pendente</option>
        </select>
      </div>

      <div style="display: flex; gap: 12px;">
        <button onclick="fecharModalCriarUsuario()" class="btn btn-secondary" style="flex: 1;">Cancelar</button>
        <button onclick="salvarNovoUsuario()" class="btn btn-primary" style="flex: 1;">üíæ Criar</button>
      </div>
    </div>
  </div>

  <p class="footer">¬© 2026 Self-Labs. Todos os direitos reservados.</p>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // Verifica autentica√ß√£o admin
    if (!initAdminPage()) throw new Error('N√£o autorizado');

    let unidadesCache = [];

    // === Tabs ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // === Pendentes ===
    async function carregarPendentes() {
      try {
        const pendentes = await listarUsuariosPendentes();
        const container = document.getElementById('listaPendentes');
        const semPendentes = document.getElementById('semPendentes');

        if (pendentes.length === 0) {
          container.innerHTML = '';
          semPendentes.classList.remove('hidden');
          return;
        }

        semPendentes.classList.add('hidden');
        container.innerHTML = pendentes.map(u => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; background: #fffbeb;">
            <div>
              <p style="font-weight: bold;">${u.nome}</p>
              <p style="font-size: 13px; color: #666;">${u.email} ‚Ä¢ ${u.unidade_sigla || 'Sem unidade'}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="aprovar('${u.id}')" class="btn btn-success" style="padding: 6px 12px;">‚úÖ Aprovar</button>
              <button onclick="rejeitar('${u.id}')" class="btn btn-danger" style="padding: 6px 12px;">‚ùå Rejeitar</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Erro ao carregar pendentes:', err);
      }
    }

    async function aprovar(id) {
      try {
        await aprovarUsuario(id);
        alert('‚úÖ Usu√°rio aprovado!');
        carregarPendentes();
        carregarUsuarios();
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    async function rejeitar(id) {
      if (!confirm('Tem certeza que deseja rejeitar e remover este usu√°rio?')) return;
      try {
        await removerUsuario(id);
        alert('Usu√°rio removido.');
        carregarPendentes();
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === Usu√°rios ===
    async function carregarUsuarios() {
      try {
        const usuarios = await listarUsuarios();
        usuariosCache = usuarios;
        document.getElementById('listaUsuarios').innerHTML = usuarios.map(u => {
        // L√≥gica de Hierarquia Visual (busca por ID para evitar duplicatas como COPOM)
        let nomeUnidade = u.unidade_sigla || '-';
        const unidade = unidadesCache.find(x => x.id === u.unidade_id);
        if (unidade) {
           const getCaminho = (id) => {
             const un = unidadesCache.find(x => x.id === id);
             if (!un) return [];
             if (!un.parent_id) return [un.sigla];
             return [...getCaminho(un.parent_id), un.sigla];
           };
           const caminho = getCaminho(u.unidade_id);
           if (caminho.length > 0) nomeUnidade = caminho.join(' / ');
        }

        return `
        <tr>
          <td style="font-weight: 600;">${u.nome}</td>
          <td>${u.email}</td>
          <td style="font-size: 13px; color: #4b5563;">${nomeUnidade}</td>
          <td>
            <select onchange="mudarRole('${u.id}', this.value)" class="form-select" style="width: auto; padding: 4px 8px; font-size: 12px;">
              <option value="editor" ${u.role === 'editor' ? 'selected' : ''}>Editor</option>
              <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </td>
          <td>
            <span style="padding: 2px 8px; border-radius: 4px; font-size: 12px; ${u.ativo ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
              ${u.ativo ? 'Ativo' : 'Pendente'}
            </span>
          </td>
          <td>
            <button onclick="abrirEditarUsuario('${u.id}')" class="btn-icon" title="Editar">‚úèÔ∏è</button>
            <button onclick="excluirUsuario('${u.id}', '${u.nome}')" class="btn-icon" title="Excluir">üóëÔ∏è</button>
          </td>
        </tr>
      `}).join('');
      } catch (err) {
        console.error('Erro ao carregar usu√°rios:', err);
      }
    }

    async function mudarRole(id, role) {
      try {
        await alterarRoleUsuario(id, role);
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
        carregarUsuarios();
      }
    }

    async function excluirUsuario(id, nome) {
      if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) return;
      try {
        await removerUsuario(id);
        carregarUsuarios();
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === Unidades ===
    async function carregarUnidades() {
      try {
        // Corre√ß√£o Item 2: Busca TODAS (incluindo inativas)
        unidadesCache = await listarTodasUnidades();
        renderUnidades();
        renderSelectParent();
      } catch (err) {
        console.error('Erro ao carregar unidades:', err);
      }
    }

    // Nova L√≥gica Recursiva de √Årvore
    function montarArvore(lista) {
      const mapa = {};
      const raizes = [];
      
      // 1. Cria mapa de refer√™ncias
      lista.forEach(u => mapa[u.id] = { ...u, children: [] });

      // 2. Conecta pais e filhos
      lista.forEach(u => {
        if (u.parent_id && mapa[u.parent_id]) {
          mapa[u.parent_id].children.push(mapa[u.id]);
        } else {
          raizes.push(mapa[u.id]);
        }
      });
      
      // 3. Ordena recursivamente por Sigla
      const ordenar = (nos) => {
        nos.sort((a, b) => a.sigla.localeCompare(b.sigla));
        nos.forEach(no => ordenar(no.children));
      };
      ordenar(raizes);

      return raizes;
    }

    function renderUnidades() {
      const arvore = montarArvore(unidadesCache);
      let html = '';

      const renderLinha = (u, nivel) => {
        const padding = nivel * 24; 
        const isRaiz = nivel === 0;

        // Classes do CSS
        const rowClass = isRaiz ? 'unit-row-root' : 'unit-row-child';
        const siglaClass = isRaiz ? 'unit-sigla-root' : 'unit-sigla-child';

        // √çcone hier√°rquico
        let icone = '';
        if (nivel > 0) icone = `<span style="color:#9ca3af; margin-right:4px;">‚Ü≥</span>`;
        else if (u.children.length > 0) icone = `<span style="margin-right:4px;">üè¢</span>`;

        // Badge de Status (Classe CSS)
        const inativoTag = !u.ativo ? '<span class="unit-inactive">(Inativo)</span>' : '';

        // Cor do Badge por Tipo
        let badgeClass = 'badge-secondary';
        if (u.tipo === 'CPOR' || u.tipo === 'CPOE') badgeClass = 'badge-primary';
        else if (u.tipo === 'BPM') badgeClass = 'badge-success';
        else if (u.tipo === 'CIA' || u.tipo === 'CIA_IND') badgeClass = 'badge-warning';
        else if (u.tipo === 'COPOM') badgeClass = 'badge-danger';

        // O padding-left continua inline pois √© c√°lculo matem√°tico din√¢mico
        let row = `
          <tr class="${rowClass}">
            <td class="${siglaClass}" style="padding-left: ${padding + 12}px;">
              ${icone} ${u.sigla} ${inativoTag}
            </td>
            <td><span class="badge ${badgeClass}">${u.tipo.replace('_', ' ')}</span></td>
            <td class="text-right">
              <button onclick="abrirEditarUnidade('${u.id}')" class="btn-icon" title="Editar">‚úèÔ∏è</button>
              <button onclick="excluirUnidade('${u.id}', '${u.sigla}')" class="btn-icon" title="Excluir">üóëÔ∏è</button>
            </td>
          </tr>
        `;

        u.children.forEach(filho => { row += renderLinha(filho, nivel + 1); });
        return row;
      };

      arvore.forEach(raiz => { html += renderLinha(raiz, 0); });
      document.getElementById('listaUnidades').innerHTML = html;
    }

    function renderSelectParent() {
      const select = document.getElementById('novoParent');
      select.innerHTML = '<option value="">Nenhuma (raiz)</option>' + gerarOpcoesRecursivas();
    }

    function gerarOpcoesRecursivas(ignorarId = null) {
      const arvore = montarArvore(unidadesCache);
      let html = '';

      const renderOpt = (u, nivel) => {
        if (u.id === ignorarId) return '';

        const prefixo = '&nbsp;&nbsp;'.repeat(nivel) + (nivel > 0 ? '‚Ü≥ ' : '');
        let opt = `<option value="${u.id}">${prefixo}${u.sigla}</option>`;

        u.children.forEach(filho => { opt += renderOpt(filho, nivel + 1); });
        return opt;
      };

      arvore.forEach(raiz => { html += renderOpt(raiz, 0); });
      return html;
    }

    async function criarNovaUnidade() {
      const sigla = document.getElementById('novaSigla').value.trim();
      const tipo = document.getElementById('novoTipo').value;
      const parent_id = document.getElementById('novoParent').value || null;

      if (!sigla || !tipo) {
        alert('Preencha Sigla e Tipo!');
        return;
      }

      try {
        await criarUnidade({ sigla, tipo, parent_id });
        document.getElementById('novaSigla').value = '';
        document.getElementById('novoTipo').value = '';
        document.getElementById('novoParent').value = '';
        carregarUnidades();
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    async function excluirUnidade(id, sigla) {
      if (!confirm(`Tem certeza que deseja excluir "${sigla}"? Subunidades tamb√©m ser√£o removidas.`)) return;
      try {
        await removerUnidade(id);
        carregarUnidades();
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === L√≥gica de Selects em Cascata (Novo Usu√°rio) ===
    function carregarUnidadesPrincipaisNew() {
      const parentId = document.getElementById('newUserComando').value;
      const select = document.getElementById('newUserUnidade');
      const selectSub = document.getElementById('newUserSubunidade');

      select.innerHTML = '<option value="">Selecione a unidade (Opcional)</option>';
      selectSub.innerHTML = '<option value="">Selecione a subunidade (Opcional)</option>';
      selectSub.disabled = true;

      if (!parentId) return;

      const filhas = unidadesCache.filter(u => u.parent_id == parentId);
      filhas.sort((a,b) => a.sigla.localeCompare(b.sigla));
      filhas.forEach(u => select.appendChild(new Option(u.sigla, u.id)));
    }

    function carregarSubunidadesNew() {
      const parentId = document.getElementById('newUserUnidade').value;
      const select = document.getElementById('newUserSubunidade');

      select.innerHTML = '<option value="">Selecione a subunidade (Opcional)</option>';

      if (!parentId) {
        select.disabled = true;
        return;
      }

      const netas = unidadesCache.filter(u => u.parent_id == parentId);
      netas.sort((a,b) => a.sigla.localeCompare(b.sigla));
      netas.forEach(u => select.appendChild(new Option(u.sigla, u.id)));
      select.disabled = false;
    }

    // === L√≥gica de Selects em Cascata (Editar Usu√°rio) ===
    function carregarUnidadesPrincipaisEdit() {
      const parentId = document.getElementById('editUserComando').value;
      const select = document.getElementById('editUserUnidade');
      const selectSub = document.getElementById('editUserSubunidade');

      select.innerHTML = '<option value="">Selecione a unidade (Opcional)</option>';
      selectSub.innerHTML = '<option value="">Selecione a subunidade (Opcional)</option>';
      selectSub.disabled = true;

      if (!parentId) return;

      const filhas = unidadesCache.filter(u => u.parent_id == parentId);
      filhas.sort((a,b) => a.sigla.localeCompare(b.sigla));
      filhas.forEach(u => select.appendChild(new Option(u.sigla, u.id)));
    }

    function carregarSubunidadesEdit() {
      const parentId = document.getElementById('editUserUnidade').value;
      const select = document.getElementById('editUserSubunidade');

      select.innerHTML = '<option value="">Selecione a subunidade (Opcional)</option>';

      if (!parentId) {
        select.disabled = true;
        return;
      }

      const netas = unidadesCache.filter(u => u.parent_id == parentId);
      netas.sort((a,b) => a.sigla.localeCompare(b.sigla));
      netas.forEach(u => select.appendChild(new Option(u.sigla, u.id)));
      select.disabled = false;
    }

    // === Modal Editar Usu√°rio (L√≥gica Reverso) ===
    async function abrirEditarUsuario(id) {
      const usuario = usuariosCache.find(u => u.id === id);
      if (!usuario) return;

      document.getElementById('editUserId').value = usuario.id;
      document.getElementById('editUserNome').value = usuario.nome;
      document.getElementById('editUserEmail').value = usuario.email;
      document.getElementById('editUserRole').value = usuario.role;
      document.getElementById('editUserAtivo').value = usuario.ativo.toString();

      // 1. Popula Comandos Regionais
      const selCmd = document.getElementById('editUserComando');
      selCmd.innerHTML = '<option value="">Selecione...</option>';
      const raizes = unidadesCache.filter(u => !u.parent_id);
      raizes.sort((a,b) => a.sigla.localeCompare(b.sigla));
      raizes.forEach(u => selCmd.appendChild(new Option(u.sigla, u.id)));

      // 2. Tenta descobrir a hierarquia do usu√°rio para preencher os selects
      const selUni = document.getElementById('editUserUnidade');
      const selSub = document.getElementById('editUserSubunidade');

      // Reseta os filhos
      selUni.innerHTML = '<option value="">Selecione a unidade (Opcional)</option>';
      selSub.innerHTML = '<option value="">Selecione a subunidade (Opcional)</option>';
      selSub.disabled = true;

      // Busca a unidade atual do usu√°rio (por ID para evitar duplicatas como COPOM)
      let unidadeAlvo = unidadesCache.find(u => u.id === usuario.unidade_id);

      if (unidadeAlvo) {
        // Reconstr√≥i o caminho at√© a raiz (Subunidade -> Unidade -> Comando)
        const path = [unidadeAlvo];
        let curr = unidadeAlvo;
        while(curr.parent_id) {
          curr = unidadesCache.find(u => u.id === curr.parent_id);
          if(curr) path.unshift(curr);
          else break;
        }

        // path[0] = Comando, path[1] = Unidade, path[2] = Subunidade
        if (path[0]) {
          selCmd.value = path[0].id;
          carregarUnidadesPrincipaisEdit(); // Carrega o n√≠vel 2
        }

        if (path[1]) {
          selUni.value = path[1].id;
          carregarSubunidadesEdit(); // Carrega o n√≠vel 3
        }

        if (path[2]) {
          selSub.value = path[2].id;
        }
      }

      document.getElementById('modalEditarUsuario').classList.remove('hidden');
    }

    function fecharModalUsuario() {
      document.getElementById('modalEditarUsuario').classList.add('hidden');
    }

    async function salvarUsuario() {
      const id = document.getElementById('editUserId').value;
      
      // L√≥gica de Prioridade: Subunidade > Unidade > Comando Regional
      const unidadeFinal = document.getElementById('editUserSubunidade').value || document.getElementById('editUserUnidade').value || document.getElementById('editUserComando').value;

      const dados = {
        nome: document.getElementById('editUserNome').value,
        email: document.getElementById('editUserEmail').value,
        role: document.getElementById('editUserRole').value,
        unidade_id: unidadeFinal || null,
        ativo: document.getElementById('editUserAtivo').value === 'true'
      };

      try {
        await atualizarUsuario(id, dados);
        fecharModalUsuario();
        carregarUsuarios();
        alert('‚úÖ Usu√°rio atualizado!');
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === Modal Editar Unidade ===
    function abrirEditarUnidade(id) {
      const unidade = unidadesCache.find(u => u.id === id);
      if (!unidade) return;

      document.getElementById('editUnidadeId').value = unidade.id;
      document.getElementById('editUnidadeSigla').value = unidade.sigla;
      document.getElementById('editUnidadeTipo').value = unidade.tipo;
      document.getElementById('editUnidadeAtivo').value = unidade.ativo.toString();

      // Popula select de parent (excluindo a pr√≥pria unidade)
      const selectParent = document.getElementById('editUnidadeParent');
      selectParent.innerHTML = '<option value="">Nenhuma (raiz)</option>' + gerarOpcoesRecursivas(id);

      if (unidade.parent_id) {
        selectParent.value = unidade.parent_id;
      }

      document.getElementById('modalEditarUnidade').classList.remove('hidden');
    }

    function fecharModalUnidade() {
      document.getElementById('modalEditarUnidade').classList.add('hidden');
    }

    async function salvarUnidade() {
      const id = document.getElementById('editUnidadeId').value;
      const dados = {
        sigla: document.getElementById('editUnidadeSigla').value,
        tipo: document.getElementById('editUnidadeTipo').value,
        parent_id: document.getElementById('editUnidadeParent').value || null,
        ativo: document.getElementById('editUnidadeAtivo').value === 'true'
      };

      try {
        await atualizarUnidade(id, dados);
        fecharModalUnidade();
        carregarUnidades();
        alert('‚úÖ Unidade atualizada!');
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === Modal Criar Usu√°rio (Inicializa√ß√£o) ===
    function abrirCriarUsuario() {
      // Limpa campos
      document.getElementById('newUserNome').value = '';
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserSenha').value = '';
      document.getElementById('newUserRole').value = 'editor';
      document.getElementById('newUserAtivo').value = 'true';

      // Popula comandos (Unidades Raiz)
      const selectComando = document.getElementById('newUserComando');
      selectComando.innerHTML = '<option value="">Selecione...</option>';

      const principais = unidadesCache.filter(u => !u.parent_id);
      principais.sort((a,b) => a.sigla.localeCompare(b.sigla));
      principais.forEach(u => {
        selectComando.appendChild(new Option(u.sigla, u.id));
      });

      document.getElementById('newUserUnidade').innerHTML = '<option value="">Selecione a unidade primeiro</option>';
      document.getElementById('newUserSubunidade').innerHTML = '<option value="">Selecione a unidade primeiro</option>';
      document.getElementById('newUserSubunidade').disabled = true;

      document.getElementById('modalCriarUsuario').classList.remove('hidden');
    }

    function fecharModalCriarUsuario() {
      document.getElementById('modalCriarUsuario').classList.add('hidden');
    }

    async function salvarNovoUsuario() {
      const unidadeFinal = document.getElementById('newUserSubunidade').value || document.getElementById('newUserUnidade').value || document.getElementById('newUserComando').value;

      const dados = {
        nome: document.getElementById('newUserNome').value,
        email: document.getElementById('newUserEmail').value,
        senha: document.getElementById('newUserSenha').value,
        role: document.getElementById('newUserRole').value,
        unidade_id: unidadeFinal || null,
        ativo: document.getElementById('newUserAtivo').value === 'true'
      };

      if (!dados.nome || !dados.email || !dados.senha) {
        alert('Preencha nome, email e senha!');
        return;
      }

      try {
        await criarUsuarioManual(dados);
        fecharModalCriarUsuario();
        carregarUsuarios();
        alert('‚úÖ Usu√°rio criado com sucesso!');
      } catch (err) {
        alert('‚ùå Erro: ' + err.message);
      }
    }

    // === Init ===
    async function inicializar() {
      await carregarUnidades();
      carregarPendentes();
      carregarUsuarios();
    }

    inicializar();
    console.log('üöÄ Admin v2.6');
  </script>

</body>
</html>