<!DOCTYPE html>
<!--
  Sistema de Escalas - Escala ISEO
  Vers√£o: 2.3
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala ISEO - Sistema de Escalas</title>
  <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    @media print {
      @page { size: A4 portrait; margin: 10mm; }
    }
  </style>
</head>

<body class="auth-loading">

  <!-- NAVBAR -->
  <nav class="navbar no-print">
    <div class="navbar-content" style="max-width: 1000px;">
      <div class="navbar-brand">
        üìã Escala ISEO
        <span class="navbar-version">v3.8</span>
      </div>
      <div class="navbar-menu">
        <select id="adminUnitSelect" class="form-select hidden" style="width: auto; max-width: 350px; padding: 4px; font-size: 12px; margin-right: 10px;">
          <option value="">Carregando...</option>
        </select>
        
        <a href="/perfil" id="navbarUser" class="navbar-user" style="text-decoration: none; color: inherit; margin-right: 8px;" title="Ir para Perfil"></a>
        <a href="/mensal" class="btn btn-secondary">üìÖ Mensal</a>
        <a href="/iseo" class="btn btn-active">üöì ISEO</a>
        <a href="/admin" id="adminMenu" class="btn btn-secondary hidden">‚öôÔ∏è Admin</a>
        <button onclick="logout()" class="btn btn-secondary">üö™ Sair</button>
      </div>
    </div>
  </nav>

  <!-- BARRA DE CONTROLE -->
  <div class="no-print" style="background: var(--pm-blue); padding: 12px;">
    <div style="max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 8px;">
      <div style="display: flex; gap: 16px; align-items: center;">
        <button id="btnEditar" class="btn btn-active">üñäÔ∏è Edi√ß√£o</button>
        <button id="btnVisualizar" class="btn btn-secondary">üîç Visualizar</button>
        <button onclick="salvarAgora()" class="btn btn-success">üíæ Salvar</button>
        <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Imprimir/PDF</button>
        <span id="statusSalvo" class="status-salvo salvo">‚úì Salvo</span>
      </div>
      <span id="auditTrail" class="audit-info"></span>
    </div>
  </div>

  <!-- MODO EDI√á√ÉO -->
  <div id="modoEdicao" class="no-print" style="max-width: 1000px; margin: 24px auto; padding: 0 16px;">

    <!-- Tabs -->
    <div style="display: flex; border-bottom: 1px solid #ddd; margin-bottom: 24px;">
      <button class="tab-btn active" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
      <button class="tab-btn" data-tab="dados">üìÖ Dados da Escala</button>
      <button class="tab-btn" data-tab="militares">üëÆ‚Äç‚ôÇÔ∏è Militares</button>
      <button class="tab-btn" data-tab="observacoes">üìù Observa√ß√µes</button>
    </div>

    <!-- Tab: Configura√ß√µes -->
    <div id="tab-config" class="tab-content active card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">‚öôÔ∏è Configura√ß√µes Gerais</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Bras√µes -->
        <div style="grid-column: span 2;">
          <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">üèõÔ∏è Bras√µes</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="font-size: 12px; color: #666;">Bras√£o Esquerdo</label>
              <input type="file" id="brasaoEsqFile" accept="image/*" class="form-input" style="font-size: 12px;" onchange="carregarBrasao('esq')">
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Bras√£o Direito</label>
              <input type="file" id="brasaoDirFile" accept="image/*" class="form-input" style="font-size: 12px;" onchange="carregarBrasao('dir')">
            </div>
          </div>
        </div>

        <!-- Cabe√ßalho -->
        <div>
          <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">üìÑ Cabe√ßalho</h3>
          <input type="text" id="headerLinha1" class="form-input mb-2" value="ESTADO DO ESP√çRITO SANTO">
          <input type="text" id="headerLinha2" class="form-input mb-2" value="POL√çCIA MILITAR">
          <input type="text" id="headerLinha3" class="form-input mb-2" value="3¬∫ COMANDO DE POL√çCIA OSTENSIVA REGIONAL">
          <input type="text" id="headerLema" class="form-input" value='"Policial Militar, her√≥i protetor da sociedade"'>
        </div>

        <!-- Assinatura -->
        <div>
          <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">‚úçÔ∏è Assinatura</h3>
          <input type="text" id="assinaturaNome" class="form-input mb-2" placeholder="Nome" value="EMILIA ALVES">
          <input type="text" id="assinaturaPosto" class="form-input mb-2" placeholder="Posto" value="CEL QOCPM">
          <input type="text" id="assinaturaCargo" class="form-input" placeholder="Cargo" value="COMANDANTE DO 3¬∫ CPOR">
        </div>

        <!-- Rodap√© -->
        <div style="grid-column: span 2;">
          <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">üìç Rodap√©</h3>
          <input type="text" id="footerLema" class="form-input mb-2" value='"Pol√≠cia Militar, patrim√¥nio do povo capixaba"'>
          <input type="text" id="footerLinha1" class="form-input mb-2" value="3¬∫ COMANDO DE POL√çCIA OSTENSIVA REGIONAL">
          <input type="text" id="footerLinha2" class="form-input mb-2" value="Av. Nossa Senhora da Consola√ß√£o, 234, Vila Rica, Cachoeiro de Itapemirim/ES">
          <input type="text" id="footerLinha3" class="form-input" value="CEP 29.301-080 ‚Äì Telefone: (28) 3515-3371 - e-mail: chefedo.cpos@pm.es.gov.br">
        </div>
      </div>

      <p class="footer">¬© 2026 Self-Labs. Todos os direitos reservados.</p>
    </div>

    <!-- Tab: Dados da Escala -->
    <div id="tab-dados" class="tab-content card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">üìÖ Dados da Escala</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label style="font-size: 12px; color: #666;">Data</label>
          <input type="date" id="dataEscala" class="form-input" onchange="atualizarDiaSemana()">
        </div>
        <div>
          <label style="font-size: 12px; color: #666;">Dia da Semana</label>
          <input type="text" id="diaSemana" class="form-input" readonly style="background: #f3f4f6;">
        </div>
        <div>
          <label style="font-size: 12px; color: #666;">Nome da Opera√ß√£o</label>
          <input type="text" id="nomeOperacao" class="form-input" placeholder="Ex: OPERA√á√ÉO NATALINA">
        </div>
        <div>
          <label style="font-size: 12px; color: #666;">Rubrica ISEO</label>
          <input type="text" id="rubricaISEO" class="form-input" placeholder="Ex: ISEO N¬∫ 020/2026">
        </div>
        <div>
          <label style="font-size: 12px; color: #666;">Hor√°rio da Escala</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="time" id="horarioInicio" class="form-input" style="flex: 1;">
            <span>√†s</span>
            <input type="time" id="horarioFim" class="form-input" style="flex: 1;">
          </div>
        </div>
        <div>
          <label style="font-size: 12px; color: #666;">Hor√°rio de Apresenta√ß√£o</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="time" id="horarioApresentacao" class="form-input" style="flex: 1;">
            <span>no</span>
            <input type="text" id="localApresentacao" class="form-input" placeholder="Ex: 9¬∫ BPM" style="flex: 2;">
          </div>
        </div>
      </div>

      <p class="footer">¬© 2026 Self-Labs. Todos os direitos reservados.</p>
    </div>

    <!-- Tab: Militares -->
    <div id="tab-militares" class="tab-content card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">üëÆ‚Äç‚ôÇÔ∏è Militares da Escala</h2>

      <div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 120px;">
          <label style="font-size: 12px; color: #666;">Posto/Grad</label>
          <select id="novoPosto" class="form-select" onchange="togglePostoManual()">
            <option value="">Selecione</option>
            <option>CEL</option>
            <option>TEN CEL</option>
            <option>MAJ</option>
            <option>CAP</option>
            <option>1¬∫ TEN</option>
            <option>2¬∫ TEN</option>
            <option>ASP</option>
            <option>ST</option>
            <option>1¬∫ SGT</option>
            <option>2¬∫ SGT</option>
            <option>3¬∫ SGT</option>
            <option>CB</option>
            <option>SD</option>
            <option value="OUTRO">Outro (digitar)</option>
          </select>
          <input type="text" id="novoPostoManual" class="form-input hidden mt-2" placeholder="Digite o posto">
        </div>
        <div style="flex: 1; min-width: 100px;">
          <label style="font-size: 12px; color: #666;">Quadro</label>
          <select id="novoQuadro" class="form-select">
            <option value="">-</option>
            <option>QOCPM</option>
            <option>QOAPM</option>
            <option>QPMP-C</option>
            <option>QPMP-S</option>
            <option>QPMP-M</option>
          </select>
        </div>
        <div style="flex: 2; min-width: 150px;">
          <label style="font-size: 12px; color: #666;">Nome de Guerra</label>
          <input type="text" id="novoNome" class="form-input" placeholder="Nome">
        </div>
        <div style="flex: 1; min-width: 100px;">
          <label style="font-size: 12px; color: #666;">RG</label>
          <input type="text" id="novoRG" class="form-input" placeholder="00.000-0" maxlength="9" oninput="mascaraRG(this)">
        </div>
        <div style="flex: 1; min-width: 100px;">
          <label style="font-size: 12px; color: #666;">NF</label>
          <input type="text" id="novoNF" class="form-input" placeholder="000000">
        </div>
        <button onclick="adicionarMilitar()" class="btn btn-primary">‚ûï Adicionar</button>
      </div>

      <div style="border: 1px solid #ddd; border-radius: 8px; max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th style="width: 40px;">#</th>
              <th>Posto/Grad</th>
              <th>Quadro</th>
              <th>Nome</th>
              <th>RG</th>
              <th>NF</th>
              <th style="width: 120px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="listaMilitares"></tbody>
        </table>
      </div>
      <p style="font-size: 12px; color: #666; margin-top: 8px;">üí° Use as setas para reordenar os militares na lista.</p>

      <p class="footer">¬© 2026 Self-Labs. Todos os direitos reservados.</p>
    </div>

    <!-- Tab: Observa√ß√µes -->
    <div id="tab-observacoes" class="tab-content card">
      <h2 style="font-size: 18px; margin-bottom: 16px;">üìù Observa√ß√µes</h2>

      <div class="mb-4">
        <label style="font-size: 12px; color: #666;">Setor</label>
        <input type="text" id="setorObs" class="form-input" placeholder="Ex: SETOR I - √ÅREA CENTRAL">
      </div>

      <div id="observacoesContainer" style="display: flex; flex-direction: column; gap: 12px;"></div>
      <button onclick="adicionarObservacao()" class="btn btn-secondary mt-4">‚ûï Adicionar Observa√ß√£o</button>

      <p class="footer">¬© 2026 Self-Labs. Todos os direitos reservados.</p>
    </div>

  </div>

  <!-- MODO VISUALIZA√á√ÉO -->
  <div id="modoVisualizacao" class="hidden">
    <div id="documento" style="background: white; max-width: 210mm; margin: 24px auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px;">

      <!-- Cabe√ßalho -->
      <header style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 48px;">
          <div id="brasaoEsqView"></div>
          <div style="text-align: center; line-height: 1.4;" id="headerTexto"></div>
          <div id="brasaoDirView"></div>
        </div>
      </header>

      <!-- T√≠tulo Opera√ß√£o -->
      <div style="text-align: center; margin-bottom: 16px;">
        <h2 id="tituloOperacao" style="font-size: 16px; font-weight: bold; text-transform: uppercase;"></h2>
        <p id="subtituloISEO" style="font-size: 14px; font-weight: bold;"></p>
      </div>

      <!-- Info Escala -->
      <div style="margin-bottom: 16px; font-size: 13px;">
        <p><strong>DIA:</strong> <span id="viewDia"></span> (<span id="viewDiaSemana"></span>)</p>
        <p><strong>HOR√ÅRIO:</strong> <span id="viewHorario"></span></p>
        <p><strong>APRESENTA√á√ÉO:</strong> <span id="viewApresentacao"></span></p>
      </div>

      <!-- Tabela Militares -->
      <table id="tabelaMilitares" class="print-table" style="margin-bottom: 16px;"></table>

      <!-- Observa√ß√µes -->
      <div id="observacoesView" style="font-size: 12px; margin-bottom: 24px;"></div>

      <!-- Assinatura -->
      <div style="text-align: center; margin-top: 48px; margin-bottom: 24px;">
        <div style="display: inline-block; border-top: 1px solid black; padding-top: 8px; min-width: 300px;">
          <p style="font-size: 14px; font-weight: bold;" id="assinaturaTexto"></p>
          <p style="font-size: 12px;" id="assinaturaCargoTexto"></p>
        </div>
      </div>

      <!-- Rodap√© -->
      <footer style="text-align: center; font-size: 11px; border-top: 1px solid #ccc; padding-top: 12px;">
        <p style="font-style: italic; font-weight: bold;" id="footerLemaTexto"></p>
        <p id="footerLinha1Texto"></p>
        <p id="footerLinha2Texto"></p>
        <p id="footerLinha3Texto"></p>
      </footer>

    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // Verifica autentica√ß√£o
    if (!isLoggedIn()) window.location.href = '/login.html';

    let currentUnidadeId = null;

    // === INICIALIZA√á√ÉO COM SUPORTE A SUPER ADMIN ===
    (async () => {
      try {
        const user = await buscarMeuPerfil();
        document.getElementById('navbarUser').textContent = `${user.nome} (${user.role})`;
        
        currentUnidadeId = user.unidade_id;

        // L√≥gica SUPER ADMIN
        if (user.role === 'admin') {
          document.getElementById('adminMenu').classList.remove('hidden');

          const select = document.getElementById('adminUnitSelect');
          select.classList.remove('hidden'); 

          const unidades = await listarTodasUnidades();

          // L√≥gica de Caminho Completo
          const mapUnidades = new Map(unidades.map(u => [u.id, u]));

          const getNomeCompleto = (u) => {
            if (!u.parent_id) return u.sigla;
            const pai = mapUnidades.get(u.parent_id);
            return pai ? `${getNomeCompleto(pai)} / ${u.sigla}` : u.sigla;
          };

          const listaOrdenada = unidades.map(u => ({
            id: u.id,
            nome: getNomeCompleto(u)
          })).sort((a, b) => a.nome.localeCompare(b.nome));

          select.innerHTML = listaOrdenada
            .map(u => `<option value="${u.id}">${u.nome}</option>`)
            .join('');

          // Prioridade: 1. localStorage | 2. Unidade do Perfil | 3. Primeira da lista
          const savedUnitId = localStorage.getItem('pmes_admin_last_unit');
          
          if (savedUnitId && unidades.some(u => u.id === savedUnitId)) {
            currentUnidadeId = savedUnitId;
          } else {
            currentUnidadeId = user.unidade_id || (unidades.length > 0 ? unidades[0].id : null);
          }
          
          if (currentUnidadeId) select.value = currentUnidadeId;

          select.addEventListener('change', (e) => {
            currentUnidadeId = e.target.value;
            localStorage.setItem('pmes_admin_last_unit', currentUnidadeId); // Salva a escolha
            carregarDados();
          });
        }

        document.body.classList.remove('auth-loading');
        carregarDados();
      } catch (err) {
        console.error(err);
        logout();
      }
    })();

    // === Auto-save ===
    let autoSaveTimer = null;
    let dadosAlterados = false;
    let isLoading = true;

    function marcarAlterado() {
      if (isLoading) return;

      dadosAlterados = true;
      atualizarStatus('pendente');

      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        salvarAgora();
      }, 3000);
    }

    function atualizarStatus(status) {
      const el = document.getElementById('statusSalvo');
      el.className = 'status-salvo ' + status;

      switch(status) {
        case 'salvando': el.innerHTML = '‚è≥ Salvando...'; break;
        case 'salvo': el.innerHTML = '‚úì Salvo'; break;
        case 'erro': el.innerHTML = '‚ùå Erro'; break;
        case 'pendente': el.innerHTML = '‚óè Alterado'; break;
      }
    }

    async function salvarAgora() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      if (isLoading) return;

      atualizarStatus('salvando');

      try {
        coletarTudo();

        // Audit Trail
        const user = await buscarMeuPerfil();
        DB.config.ultima_alteracao = new Date().toLocaleString('pt-BR');
        DB.config.alterado_por = user.nome;

        // Atualiza visualmente na hora
        const auditEl = document.getElementById('auditTrail');
        if (auditEl) auditEl.textContent = `√öltima edi√ß√£o: ${DB.config.ultima_alteracao} por ${DB.config.alterado_por}`;

        await salvarEscalaISEO({
          config: DB.config,
          dados: DB.dados,
          militares: DB.militares,
          observacoes: DB.observacoes,
          setor: DB.setor
        }, currentUnidadeId);

        dadosAlterados = false;
        atualizarStatus('salvo');
      } catch (err) {
        atualizarStatus('erro');
        console.error('Erro ao salvar:', err);
      }
    }

    // === Estado Global ===
    const DB = {
      config: {},
      dados: {},
      militares: [],
      observacoes: [],
      setor: ''
    };

    // === Tabs ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // === Edi√ß√£o/Visualiza√ß√£o ===
    document.getElementById('btnEditar').addEventListener('click', () => {
      document.getElementById('modoEdicao').classList.remove('hidden');
      document.getElementById('modoVisualizacao').classList.add('hidden');
      document.getElementById('btnEditar').className = 'btn btn-active';
      document.getElementById('btnVisualizar').className = 'btn btn-secondary';
    });

    document.getElementById('btnVisualizar').addEventListener('click', () => {
      coletarTudo();
      renderizarDocumento();
      document.getElementById('modoEdicao').classList.add('hidden');
      document.getElementById('modoVisualizacao').classList.remove('hidden');
      document.getElementById('btnVisualizar').className = 'btn btn-active';
      document.getElementById('btnEditar').className = 'btn btn-secondary';
    });

    // === M√°scara RG ===
    function mascaraRG(input) {
      let v = input.value.replace(/\D/g, '');
      if (v.length > 6) v = v.slice(0, 6);
      let formatted = '';
      if (v.length > 0) formatted = v.slice(0, 2);
      if (v.length > 2) formatted += '.' + v.slice(2, 5);
      if (v.length > 5) formatted += '-' + v.slice(5, 6);
      input.value = formatted;
    }

    // === Toggle posto manual ===
    function togglePostoManual() {
      const sel = document.getElementById('novoPosto');
      const manual = document.getElementById('novoPostoManual');
      manual.classList.toggle('hidden', sel.value !== 'OUTRO');
    }

    // === Bras√µes ===
    function carregarBrasao(lado) {
      const input = document.getElementById(lado === 'esq' ? 'brasaoEsqFile' : 'brasaoDirFile');
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        if (lado === 'esq') DB.config.brasaoEsq = e.target.result;
        else DB.config.brasaoDir = e.target.result;
        marcarAlterado();
      };
      reader.readAsDataURL(file);
    }

    // === Dia da Semana ===
    function atualizarDiaSemana() {
      const input = document.getElementById('dataEscala');
      const diaSemanaEl = document.getElementById('diaSemana');
      if (!input.value) { diaSemanaEl.value = ''; return; }
      const dias = ['DOMINGO', 'SEGUNDA-FEIRA', 'TER√áA-FEIRA', 'QUARTA-FEIRA', 'QUINTA-FEIRA', 'SEXTA-FEIRA', 'S√ÅBADO'];
      const data = new Date(input.value + 'T12:00:00');
      diaSemanaEl.value = dias[data.getDay()];
    }

    // === CRUD Militares ===
    function adicionarMilitar() {
      let posto = document.getElementById('novoPosto').value;
      if (posto === 'OUTRO') {
        posto = document.getElementById('novoPostoManual').value.trim().toUpperCase();
      }
      const quadro = document.getElementById('novoQuadro').value;
      const nome = document.getElementById('novoNome').value.trim().toUpperCase();
      const rg = document.getElementById('novoRG').value.trim();
      const nf = document.getElementById('novoNF').value.trim();

      if (!posto || !nome || !rg) { alert('Preencha Posto, Nome e RG!'); return; }

      DB.militares.push({ id: Date.now(), posto, quadro, nome, rg, nf });
      renderMilitares();
      marcarAlterado();

      // Limpar campos
      document.getElementById('novoPosto').value = '';
      document.getElementById('novoPostoManual').value = '';
      document.getElementById('novoPostoManual').classList.add('hidden');
      document.getElementById('novoQuadro').value = '';
      document.getElementById('novoNome').value = '';
      document.getElementById('novoRG').value = '';
      document.getElementById('novoNF').value = '';
    }

    function removerMilitar(id) {
      DB.militares = DB.militares.filter(m => m.id !== id);
      renderMilitares();
      marcarAlterado();
    }

    function moverMilitar(id, direcao) {
      const idx = DB.militares.findIndex(m => m.id === id);
      if (idx === -1) return;
      const novoIdx = idx + direcao;
      if (novoIdx < 0 || novoIdx >= DB.militares.length) return;
      [DB.militares[idx], DB.militares[novoIdx]] = [DB.militares[novoIdx], DB.militares[idx]];
      renderMilitares();
      marcarAlterado();
    }

    function renderMilitares() {
      document.getElementById('listaMilitares').innerHTML = DB.militares.map((m, i) => `
        <tr>
          <td style="text-align: center; color: #999;">${i + 1}</td>
          <td>${m.posto}</td>
          <td>${m.quadro || '-'}</td>
          <td style="font-weight: 600;">${m.nome}</td>
          <td>${m.rg}</td>
          <td>${m.nf || '-'}</td>
          <td style="text-align: center;">
            <button onclick="moverMilitar(${m.id}, -1)" class="btn-icon" title="Mover para cima">‚¨ÜÔ∏è</button>
            <button onclick="moverMilitar(${m.id}, 1)" class="btn-icon" title="Mover para baixo">‚¨áÔ∏è</button>
            <button onclick="removerMilitar(${m.id})" class="btn-icon" title="Remover">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // === Observa√ß√µes ===
    function renderObservacoes() {
      document.getElementById('observacoesContainer').innerHTML = DB.observacoes.map((obs, i) => `
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #666; font-weight: bold; margin-top: 8px; min-width: 50px;">Obs ${i + 1}:</span>
          <textarea class="form-input obs-input" data-index="${i}" rows="2" style="flex: 1;">${obs}</textarea>
          <button onclick="removerObservacao(${i})" class="btn-icon" title="Remover">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function adicionarObservacao() {
      coletarObservacoes();
      DB.observacoes.push('');
      renderObservacoes();
      marcarAlterado();
    }

    function removerObservacao(index) {
      coletarObservacoes();
      DB.observacoes.splice(index, 1);
      renderObservacoes();
      marcarAlterado();
    }

    function coletarObservacoes() {
      DB.observacoes = [];
      document.querySelectorAll('.obs-input').forEach(input => {
        DB.observacoes.push(input.value);
      });
    }

    // === Coletar Tudo ===
    function coletarTudo() {
      DB.config = {
        brasaoEsq: DB.config.brasaoEsq || '',
        brasaoDir: DB.config.brasaoDir || '',
        headerLinha1: document.getElementById('headerLinha1').value,
        headerLinha2: document.getElementById('headerLinha2').value,
        headerLinha3: document.getElementById('headerLinha3').value,
        headerLema: document.getElementById('headerLema').value,
        assinaturaNome: document.getElementById('assinaturaNome').value,
        assinaturaPosto: document.getElementById('assinaturaPosto').value,
        assinaturaCargo: document.getElementById('assinaturaCargo').value,
        footerLema: document.getElementById('footerLema').value,
        footerLinha1: document.getElementById('footerLinha1').value,
        footerLinha2: document.getElementById('footerLinha2').value,
        footerLinha3: document.getElementById('footerLinha3').value,
      };

      DB.dados = {
        dataEscala: document.getElementById('dataEscala').value,
        diaSemana: document.getElementById('diaSemana').value,
        nomeOperacao: document.getElementById('nomeOperacao').value,
        rubricaISEO: document.getElementById('rubricaISEO').value,
        horarioInicio: document.getElementById('horarioInicio').value,
        horarioFim: document.getElementById('horarioFim').value,
        horarioApresentacao: document.getElementById('horarioApresentacao').value,
        localApresentacao: document.getElementById('localApresentacao').value,
      };

      DB.setor = document.getElementById('setorObs').value;
      coletarObservacoes();
    }

    // === Carregar Dados ===
    function carregarDadosUI() {
      if (DB.config.headerLinha1) {
        document.getElementById('headerLinha1').value = DB.config.headerLinha1;
        document.getElementById('headerLinha2').value = DB.config.headerLinha2;
        document.getElementById('headerLinha3').value = DB.config.headerLinha3;
        document.getElementById('headerLema').value = DB.config.headerLema || '';
        document.getElementById('assinaturaNome').value = DB.config.assinaturaNome || '';
        document.getElementById('assinaturaPosto').value = DB.config.assinaturaPosto || '';
        document.getElementById('assinaturaCargo').value = DB.config.assinaturaCargo || '';
        document.getElementById('footerLema').value = DB.config.footerLema || '';
        document.getElementById('footerLinha1').value = DB.config.footerLinha1 || '';
        document.getElementById('footerLinha2').value = DB.config.footerLinha2 || '';
        document.getElementById('footerLinha3').value = DB.config.footerLinha3 || '';
      }

      if (DB.dados.dataEscala) {
        document.getElementById('dataEscala').value = DB.dados.dataEscala;
        document.getElementById('diaSemana').value = DB.dados.diaSemana || '';
        document.getElementById('nomeOperacao').value = DB.dados.nomeOperacao || '';
        document.getElementById('rubricaISEO').value = DB.dados.rubricaISEO || '';
        document.getElementById('horarioEscala').value = DB.dados.horarioEscala || '';
        document.getElementById('horarioApresentacao').value = DB.dados.horarioApresentacao || '';
      }

      document.getElementById('setorObs').value = DB.setor || '';
      renderMilitares();
      renderObservacoes();

      // Exibe auditoria se existir
      if (DB.config && DB.config.ultima_alteracao) {
        const auditEl = document.getElementById('auditTrail');
        if (auditEl) auditEl.textContent = `√öltima edi√ß√£o: ${DB.config.ultima_alteracao} por ${DB.config.alterado_por || 'Desconhecido'}`;
      }
    }

    // === Carregar Dados do Servidor ===
    async function carregarDados() {
      isLoading = true;
      try {
        // Passa currentUnidadeId
        const dados = await buscarEscalaISEO(currentUnidadeId);
        if (dados) {
          DB.config = dados.config || {};
          DB.dados = dados.dados || {};
          DB.militares = dados.militares || [];
          DB.observacoes = dados.observacoes || [];
          DB.setor = dados.setor || '';
        }
      } catch (err) {
        console.log('Nenhuma escala ISEO salva ainda');
      }
      carregarDadosUI();
      
      setTimeout(() => { isLoading = false; }, 500);
    }

    // === Renderizar Documento ===
    function renderizarDocumento() {
      const c = DB.config;
      const d = DB.dados;

      // Bras√µes
      const brasaoEsqHTML = c.brasaoEsq 
        ? `<img src="${c.brasaoEsq}" style="height: 70px; width: auto;">` 
        : '<div style="width: 70px; height: 70px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">Bras√£o</div>';
      const brasaoDirHTML = c.brasaoDir 
        ? `<img src="${c.brasaoDir}" style="height: 70px; width: auto;">` 
        : '<div style="width: 70px; height: 70px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">Bras√£o</div>';

      document.getElementById('brasaoEsqView').innerHTML = brasaoEsqHTML;
      document.getElementById('brasaoDirView').innerHTML = brasaoDirHTML;

      // Cabe√ßalho
      document.getElementById('headerTexto').innerHTML = `
        <p style="font-size: 13px; font-weight: bold; text-transform: uppercase;">${c.headerLinha1 || ''}</p>
        <p style="font-size: 18px; font-weight: bold; text-transform: uppercase;">${c.headerLinha2 || ''}</p>
        <p style="font-size: 13px; font-weight: bold; text-transform: uppercase;">${c.headerLinha3 || ''}</p>
        <p style="font-size: 12px; font-style: italic;">${c.headerLema || ''}</p>
      `;

      // T√≠tulo
      document.getElementById('tituloOperacao').textContent = d.nomeOperacao || 'OPERA√á√ÉO';
      document.getElementById('subtituloISEO').textContent = d.rubricaISEO || '';

      // Info
      const dataFormatada = d.dataEscala ? d.dataEscala.split('-').reverse().join('/') : '';
      document.getElementById('viewDia').textContent = dataFormatada;
      document.getElementById('viewDiaSemana').textContent = d.diaSemana || '';
      
      // Formatar hor√°rios
      const formatarHora = (h) => h ? h.replace(':', 'h') + 'min' : '';
      const horarioEscala = d.horarioInicio && d.horarioFim ? `${formatarHora(d.horarioInicio)} √†s ${formatarHora(d.horarioFim)}` : '';
      const horarioApres = d.horarioApresentacao ? `${formatarHora(d.horarioApresentacao)}${d.localApresentacao ? ' no ' + d.localApresentacao : ''}` : '';
      
      document.getElementById('viewHorario').textContent = horarioEscala;
      document.getElementById('viewApresentacao').textContent = horarioApres;

      // Tabela Militares
      let html = `
        <thead>
          <tr style="background: #FFD966;">
            <th style="width: 40px; text-align: center;">N¬∫</th>
            <th style="text-align: center;">POSTO/GRAD</th>
            <th style="text-align: center;">NOME DE GUERRA</th>
            <th style="text-align: center;">RG</th>
            <th style="text-align: center;">NF</th>
          </tr>
        </thead>
        <tbody>
      `;

      DB.militares.forEach((m, i) => {
        const postoQuadro = m.quadro ? `${m.posto} ${m.quadro}` : m.posto;
        html += `
          <tr>
            <td style="text-align: center;">${String(i + 1).padStart(2, '0')}</td>
            <td style="text-align: center;">${postoQuadro}</td>
            <td style="font-weight: bold;">${m.nome}</td>
            <td style="text-align: center;">${m.rg}</td>
            <td style="text-align: center;">${m.nf || '-'}</td>
          </tr>
        `;
      });

      html += '</tbody>';
      document.getElementById('tabelaMilitares').innerHTML = html;

      // Observa√ß√µes
      let obsHtml = '';
      if (DB.setor) {
        obsHtml += `<p style="font-weight: bold; margin-bottom: 8px;">Setor: ${DB.setor}</p>`;
      }
      DB.observacoes.filter(o => o.trim()).forEach((o, i) => {
        obsHtml += `<p style="margin-bottom: 4px;"><strong>Obs ${i + 1}:</strong> ${o}</p>`;
      });
      document.getElementById('observacoesView').innerHTML = obsHtml;

      // Assinatura
      document.getElementById('assinaturaTexto').textContent = `${c.assinaturaNome || ''} ‚Äì ${c.assinaturaPosto || ''}`;
      document.getElementById('assinaturaCargoTexto').textContent = c.assinaturaCargo || '';

      // Rodap√©
      document.getElementById('footerLemaTexto').textContent = c.footerLema || '';
      document.getElementById('footerLinha1Texto').textContent = c.footerLinha1 || '';
      document.getElementById('footerLinha2Texto').textContent = c.footerLinha2 || '';
      document.getElementById('footerLinha3Texto').textContent = c.footerLinha3 || '';
    }

    // === Listeners para auto-save ===
    document.querySelectorAll('#tab-config input, #tab-config select, #tab-config textarea').forEach(el => {
      el.addEventListener('input', marcarAlterado);
      el.addEventListener('change', marcarAlterado);
    });

    document.querySelectorAll('#tab-dados input, #tab-dados select').forEach(el => {
      el.addEventListener('input', marcarAlterado);
      el.addEventListener('change', marcarAlterado);
    });

    document.getElementById('setorObs').addEventListener('input', marcarAlterado);

    // Observer para mudan√ßas din√¢micas (observa√ß√µes)
    const observer = new MutationObserver(() => marcarAlterado());
    observer.observe(document.getElementById('observacoesContainer'), { childList: true, subtree: true });

    // === Init ===
    // Removido o carregarDados() daqui pois √© chamado no bloco async
    console.log('üöÄ Escala ISEO v2.3');
  </script>

</body>
</html>